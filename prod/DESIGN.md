# Production Trading System Design

## Architecture

```
prod/
├── backend/           # FastAPI server
│   ├── api/          # REST endpoints + WebSocket
│   ├── execution/    # Alpaca executor & order management
│   ├── signals/      # Strategy signal generation (imports from orb_5m/)
│   ├── db/           # SQLite/PostgreSQL for trade history
│   └── main.py       # FastAPI app entry
│
├── frontend/         # Next.js dashboard
│   ├── src/
│   │   ├── app/      # Next.js 14 app router
│   │   ├── components/  # React components
│   │   └── lib/      # API client, WebSocket hooks
│   └── package.json
│
└── shared/           # Common types/schemas
    └── types.py      # Pydantic models shared across stack
```

---

## Dashboard Pages

### 1. **Live Trading View** (Main Page)
**Route:** `/`

**Layout:**
```
┌─────────────────────────────────────────────────────────┐
│  [Kill Switch: ON/OFF]  Paper Mode: ✓  |  Account: $50k │
├─────────────────────────────────────────────────────────┤
│  Open Positions (5)                                      │
│  ┌────────┬────────┬──────────┬──────────┬──────────┐  │
│  │ Ticker │ Side   │ Entry    │ Current  │ P&L      │  │
│  ├────────┼────────┼──────────┼──────────┼──────────┤  │
│  │ AAPL   │ LONG   │ 150.00   │ 151.50   │ +$150    │  │
│  │ TSLA   │ SHORT  │ 220.00   │ 219.00   │ +$100    │  │
│  └────────┴────────┴──────────┴──────────┴──────────┘  │
├─────────────────────────────────────────────────────────┤
│  Today's Performance                                     │
│  P&L: +$450  |  Win Rate: 60%  |  Trades: 12            │
│  [Intraday P&L Chart - Real-time line]                  │
└─────────────────────────────────────────────────────────┘
```

**Features:**
- **Kill switch toggle** (top-right) — immediately stops new orders
- **Live position table** — updates via WebSocket every 1s
- **Real-time P&L chart** — intraday equity curve
- **Account summary** — buying power, equity, day P&L

---

### 2. **Signal Monitor**
**Route:** `/signals`

**Layout:**
```
┌─────────────────────────────────────────────────────────┐
│  Active Signals (3)                    [Refresh: Auto]   │
│  ┌────────┬────────┬────────┬─────────┬─────────────┐  │
│  │ Time   │ Ticker │ Side   │ Conf    │ Status      │  │
│  ├────────┼────────┼────────┼─────────┼─────────────┤  │
│  │ 09:31  │ AAPL   │ LONG   │ 0.85    │ ✅ Filled   │  │
│  │ 09:35  │ NVDA   │ SHORT  │ 0.78    │ ⏳ Pending  │  │
│  │ 09:40  │ MSFT   │ LONG   │ 0.92    │ ❌ Rejected │  │
│  └────────┴────────┴────────┴─────────┴─────────────┘  │
├─────────────────────────────────────────────────────────┤
│  Signal History (Last 50)                                │
│  [Filterable table with signal → order → fill chain]    │
└─────────────────────────────────────────────────────────┘
```

**Features:**
- **Active signals** — generated by strategy_orb.py (ORB breakouts)
- **Signal-to-order mapping** — track latency, rejections
- **Filters** — by ticker, side, status, date

---

### 3. **Historical Performance**
**Route:** `/history`

**Layout:**
```
┌─────────────────────────────────────────────────────────┐
│  Date Range: [Last 30 Days ▼]   Strategy: [ORB 2%]     │
├─────────────────────────────────────────────────────────┤
│  Cumulative P&L                                          │
│  [Line chart: Daily equity curve]                        │
├─────────────────────────────────────────────────────────┤
│  Key Metrics                                             │
│  Total P&L: $2,450  |  Win Rate: 58%  |  Sharpe: 1.2   │
│  Max DD: -$350      |  Avg Win: $85   |  Avg Loss: -$45│
├─────────────────────────────────────────────────────────┤
│  Trade Log                                               │
│  [Table: Date, Ticker, Side, Entry, Exit, P&L, Duration]│
└─────────────────────────────────────────────────────────┘
```

**Features:**
- **Equity curve** — daily cumulative returns
- **Performance metrics** — Sharpe, Sortino, max drawdown
- **Trade log export** — CSV download

---

### 4. **System Logs**
**Route:** `/logs`

**Layout:**
```
┌─────────────────────────────────────────────────────────┐
│  Severity: [All ▼]   Component: [All ▼]                 │
├─────────────────────────────────────────────────────────┤
│  Live Logs (Auto-scroll)                                 │
│  [09:31:12] INFO  | Executor    | Placed order AAPL     │
│  [09:31:15] INFO  | Executor    | Fill confirmed AAPL   │
│  [09:32:01] WARN  | RiskManager | Position limit hit    │
│  [09:35:00] ERROR | Alpaca      | API timeout retry     │
└─────────────────────────────────────────────────────────┘
```

**Features:**
- **Real-time log stream** — WebSocket updates
- **Filters** — ERROR/WARN/INFO, by component
- **Search** — full-text across logs

---

## Tech Stack

### Backend
- **FastAPI** (Python 3.10+)
- **SQLAlchemy** + SQLite (dev) / PostgreSQL (prod)
- **alpaca-py** for Alpaca REST/streaming
- **WebSocket** for real-time updates (FastAPI native)
- **Pydantic** for request/response validation

### Frontend
- **Next.js 14** (App Router)
- **React 18** + TypeScript
- **TailwindCSS** for styling
- **Recharts** for charts (P&L, equity curves)
- **SWR** for data fetching + WebSocket hooks
- **shadcn/ui** for components (tables, buttons, modals)

### Database Schema
```sql
CREATE TABLE trades (
    id INTEGER PRIMARY KEY,
    timestamp DATETIME,
    ticker VARCHAR(10),
    side VARCHAR(5),  -- LONG/SHORT
    entry_price REAL,
    exit_price REAL,
    shares INTEGER,
    pnl REAL,
    status VARCHAR(20)  -- OPEN/CLOSED
);

CREATE TABLE signals (
    id INTEGER PRIMARY KEY,
    timestamp DATETIME,
    ticker VARCHAR(10),
    side VARCHAR(5),
    confidence REAL,
    order_id VARCHAR(50),  -- Link to Alpaca order
    status VARCHAR(20)  -- PENDING/FILLED/REJECTED
);

CREATE TABLE logs (
    id INTEGER PRIMARY KEY,
    timestamp DATETIME,
    level VARCHAR(10),  -- INFO/WARN/ERROR
    component VARCHAR(50),
    message TEXT
);
```

---

## API Endpoints

### REST
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/positions` | GET | Current open positions |
| `/api/account` | GET | Account balance, buying power |
| `/api/trades` | GET | Historical trade log (paginated) |
| `/api/signals` | GET | Recent signals + statuses |
| `/api/metrics` | GET | Performance stats (Sharpe, win rate) |
| `/api/kill-switch` | POST | Toggle kill switch on/off |
| `/api/logs` | GET | System logs (paginated, filterable) |

### WebSocket
- `/ws/live` — Streams:
  - Position updates (every 1s)
  - Trade fills (real-time)
  - P&L changes
  - New signals
  - Log messages

---

## Safety & Controls

1. **Kill Switch** — Frontend toggle → backend stops all new orders
2. **Paper Mode Toggle** — Switch Alpaca env without redeployment
3. **Daily Loss Limit** — Auto-stop if down >5% (configurable)
4. **Max Positions** — Hard limit (default: 5)
5. **Manual Override** — Force-close position from dashboard

---

## Deployment Plan

### Phase 1: Local Development
- Backend: `uvicorn main:app --reload` (port 8000)
- Frontend: `npm run dev` (port 3000)
- SQLite for data

### Phase 2: Paper Trading Staging
- Docker Compose: backend + frontend + PostgreSQL
- Deploy to VPS (DigitalOcean/AWS)
- Alpaca paper account

### Phase 3: Live Production
- Same infrastructure, switch Alpaca to live keys
- Add Nginx reverse proxy
- Set up monitoring (Sentry, Grafana)

---

## Next Steps

1. **Confirm dashboard layout** — Any missing views?
2. **Build backend skeleton** — FastAPI app + DB models
3. **Build frontend skeleton** — Next.js pages + API client
4. **Wire Alpaca executor** — Import from `orb_5m/core/src/strategy_orb.py`
5. **Add WebSocket streaming** — Live position updates
6. **Paper trade validation** — 2-4 weeks testing

---

**Does this align with your vision? Any changes to the dashboard layout or features?**
